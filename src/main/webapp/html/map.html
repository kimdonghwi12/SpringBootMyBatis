<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í‹°ë§µ ì–´ë¦°ì´ë³´í˜¸êµ¬ì—­ íšŒí”¼ ìŠ¤ë§ˆíŠ¸ ê¸¸ì°¾ê¸°</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- TMAP JS ë¼ì´ë¸ŒëŸ¬ë¦¬. appKeyëŠ” ë³¸ì¸ ê²ƒìœ¼ë¡œ! -->
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=kNCek6udB12JVr0qSGaOi8ELQvMieR941FXq3TRf"></script>
    <style>
        body { font-family:'Pretendard', Arial,sans-serif; margin:0; background:#f9fafd;}
        .header { background:#2777f7; color:#fff; text-align:center; font-size:2rem; padding:25px 0 16px;}
        .panel { max-width:750px; margin:32px auto; background:#fff; border-radius:16px; box-shadow:0 2px 16px rgba(90,110,150,0.07); padding:28px 32px 20px;}
        .inputs { display:flex; gap:9px; margin-bottom:17px; align-items:center; flex-wrap:wrap;}
        input, select, button { border:1px solid #dae2ec; border-radius:8px; padding:8px 12px; font-size:1.05rem;}
        input { flex:1 1 210px; min-width:130px;}
        button { background:#2777f7; color:#fff; border:none; cursor:pointer; font-weight:600; transition:background 0.16s;}
        button:hover { background:#174eb5;}
        #map_div { width:100%; height:420px; border-radius:14px; border:1.5px solid #e3e7ee; margin:10px 0 18px;}
        #result { background:#f7fafd; border-radius:7px; padding:16px 15px 10px 15px; margin-bottom:0; font-size:1.12rem; color:#2777f7; min-height:24px;}
        .credit { text-align:right; color:#bac2da; font-size:.93rem; margin-top:11px; margin-right:6px;}
        @media (max-width: 750px) {.panel { max-width:99vw; padding:13px 2vw 9px 2vw;} .header { font-size:1.18rem; padding:16px 0 8px;} #map_div{height:250px;}}
    </style>
</head>
<body>
<div class="header">ğŸš¸ í‹°ë§µ ì–´ë¦°ì´ë³´í˜¸êµ¬ì—­ íšŒí”¼ ìŠ¤ë§ˆíŠ¸ ê¸¸ì°¾ê¸°</div>
<div class="panel">
    <div class="inputs">
        <input type="text" id="startText" placeholder="ì¶œë°œì§€ëª… or ì£¼ì†Œ" autocomplete="off">
        <button id="btn_cur">í˜„ì¬ ìœ„ì¹˜</button>
        <input type="text" id="endText" placeholder="ë„ì°©ì§€ëª… or ì£¼ì†Œ" autocomplete="off">
        <select id="searchOption">
            <option value="0" selected>êµí†µìµœì +ì¶”ì²œ</option>
            <option value="1">êµí†µìµœì +ë¬´ë£Œìš°ì„ </option>
            <option value="2">êµí†µìµœì +ìµœì†Œì‹œê°„</option>
            <option value="3">êµí†µìµœì +ì´ˆë³´</option>
            <option value="4">êµí†µìµœì +ê³ ì†ë„ë¡œìš°ì„ </option>
            <option value="10">ìµœë‹¨ê±°ë¦¬+ìœ /ë¬´ë£Œ</option>
            <option value="12">ì´ë¥œì°¨ë„ë¡œìš°ì„ </option>
            <option value="19">êµí†µìµœì +ì–´ë¦°ì´ë³´í˜¸êµ¬ì—­ íšŒí”¼</option>
        </select>
        <button id="btn_search">ê²½ë¡œ íƒìƒ‰</button>
    </div>
    <div id="map_div"></div>
    <div id="result">ì¶œë°œì§€/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ê³  [ê²½ë¡œ íƒìƒ‰]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    <div class="credit">Powered by TMAP Open API</div>
</div>
<script>
    var TMAP_APPKEY = "kNCek6udB12JVr0qSGaOi8ELQvMieR941FXq3TRf";
    var map, marker_s, marker_e, resultdrawArr = [], resultMarkerArr = [], drawInfoArr = [];

    // ì§€ë„ ì´ˆê¸°í™”
    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.554722, 126.970833), // ì„œìš¸ì—­ ê·¼ì²˜
            width: "100%",
            height: "420px",
            zoom: 12,
            zoomControl: true,
            scrollwheel: true
        });
    }

    $(document).ready(function () {
        initTmap();

        // í˜„ì¬ ìœ„ì¹˜ë¡œ ì¶œë°œì§€ ìë™ì…ë ¥
        $("#btn_cur").click(function () {
            if (!navigator.geolocation) {
                alert("ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            navigator.geolocation.getCurrentPosition(function (pos) {
                var lat = pos.coords.latitude;
                var lng = pos.coords.longitude;
                // ì—­ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ì§€ëª… ìë™ì…ë ¥ (ì—†ìœ¼ë©´ ì¢Œí‘œ ë…¸ì¶œ)
                $.ajax({
                    url: "https://apis.openapi.sk.com/tmap/geo/reversegeocoding",
                    type: "GET",
                    headers: { appKey: TMAP_APPKEY },
                    data: {
                        version: "1",
                        lat: lat,
                        lon: lng,
                        coordType: "WGS84GEO",
                        addressType: "A"
                    },
                    success: function (res) {
                        var addr = res.addressInfo.fullAddress || (lat + "," + lng);
                        $("#startText").val(addr).data("coords", { lat: lat, lng: lng });
                    },
                    error: function () {
                        $("#startText").val(lat + "," + lng).data("coords", { lat: lat, lng: lng });
                    }
                });
            }, function () {
                alert("ìœ„ì¹˜ì •ë³´ ì ‘ê·¼ ì‹¤íŒ¨");
            });
        });

        // ê²½ë¡œ íƒìƒ‰ ë²„íŠ¼ í´ë¦­
        $("#btn_search").click(function () {
            var startInput = $("#startText").val().trim();
            var endInput = $("#endText").val().trim();
            if (!startInput || !endInput) {
                $("#result").css('color', '#d11').text("ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            $("#result").css('color', '#2777f7').text("ê²½ë¡œ ê²€ìƒ‰ ì¤‘...");
            resettingMap();

            // ì¶œë°œ/ë„ì°© ì¢Œí‘œ ë³€í™˜ í›„ ê²½ë¡œ ê²€ìƒ‰
            getCoords(startInput, function (err, start) {
                if (err) {
                    $("#result").css('color', '#d11').text("ì¶œë°œì§€ ìœ„ì¹˜ ë³€í™˜ ì‹¤íŒ¨");
                    return;
                }
                getCoords(endInput, function (err2, end) {
                    if (err2) {
                        $("#result").css('color', '#d11').text("ë„ì°©ì§€ ìœ„ì¹˜ ë³€í™˜ ì‹¤íŒ¨");
                        return;
                    }
                    searchRoute(start, end);
                });
            });
        });
    });

    // ì…ë ¥ê°’ â†’ ì¢Œí‘œ ë³€í™˜ (ì£¼ì†Œ or ì¥ì†Œëª… ëª¨ë‘ ì§€ì›)
    function getCoords(query, cb) {
        // (ì´ë¯¸ í˜„ì¬ìœ„ì¹˜ ë²„íŠ¼ ë“±ì—ì„œ lat/lng ë„˜ê¸´ ê²½ìš°)
        if (typeof query === "object" && query.lat && query.lng) {
            cb(null, query);
            return;
        }

        // 1. POI(ì¥ì†Œëª…) ê²€ìƒ‰ â†’ 2. ì‹¤íŒ¨ì‹œ ì£¼ì†Œê²€ìƒ‰ â†’ 3. ë‘˜ë‹¤ ì‹¤íŒ¨ì‹œ ì¢Œí‘œë¡œ ì¸ì‹ ì‹œë„
        $.ajax({
            url: "https://apis.openapi.sk.com/tmap/pois",
            type: "GET",
            headers: { appKey: TMAP_APPKEY },
            data: {
                version: "1",
                format: "json",
                count: 1,
                searchKeyword: query,
                resCoordType: "WGS84GEO"
            },
            success: function (res) {
                if (res.searchPoiInfo && res.searchPoiInfo.pois && res.searchPoiInfo.pois.poi.length > 0) {
                    var poi = res.searchPoiInfo.pois.poi[0];
                    cb(null, { lat: parseFloat(poi.frontLat), lng: parseFloat(poi.frontLon) });
                } else {
                    // 2. ì£¼ì†Œê²€ìƒ‰(geocode) ì‹œë„
                    $.ajax({
                        url: "https://apis.openapi.sk.com/tmap/geo/fullAddrGeo",
                        type: "GET",
                        headers: { appKey: TMAP_APPKEY },
                        data: {
                            version: "1",
                            format: "json",
                            fullAddr: query
                        },
                        success: function (res2) {
                            if (res2.coordinateInfo && res2.coordinateInfo.coordinate.length > 0) {
                                var c = res2.coordinateInfo.coordinate[0];
                                cb(null, { lat: parseFloat(c.newLat), lng: parseFloat(c.newLon) });
                            } else {
                                tryParseCoord(query, cb);
                            }
                        },
                        error: function () {
                            tryParseCoord(query, cb);
                        }
                    });
                }
            },
            error: function () {
                tryParseCoord(query, cb);
            }
        });
    }

    // ë§Œì•½ ì‚¬ìš©ìê°€ "37.566,126.978" í˜•íƒœë¡œ ì…ë ¥í–ˆë‹¤ë©´ ì¢Œí‘œë¡œ ì¸ì‹
    function tryParseCoord(str, cb) {
        var match = str.match(/^([0-9.]+)[ ,]+([0-9.]+)$/);
        if (match) {
            cb(null, { lat: parseFloat(match[1]), lng: parseFloat(match[2]) });
        } else {
            cb("ë³€í™˜ì‹¤íŒ¨", null);
        }
    }

    // ê¸¸ì°¾ê¸° API í˜¸ì¶œ ë° ì§€ë„ í‘œì‹œ
    function searchRoute(start, end) {
        var searchOption = $("#searchOption").val();

        var headers = { "appKey": TMAP_APPKEY };
        $.ajax({
            type: "POST",
            headers: headers,
            url: "https://apis.openapi.sk.com/tmap/routes?version=1&format=json",
            data: {
                startX: start.lng,
                startY: start.lat,
                endX: end.lng,
                endY: end.lat,
                reqCoordType: "WGS84GEO",
                resCoordType: "EPSG3857",
                searchOption: searchOption,
                trafficInfo: "Y"
            },
            success: function (response) {
                var resultData = response.features;
                if (!resultData || resultData.length === 0) {
                    $("#result").css('color', '#d11').text("ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤!");
                    return;
                }

                // ê±°ë¦¬/ì‹œê°„/ìš”ê¸ˆ
                var tDistance = "ì´ ê±°ë¦¬ : " + (resultData[0].properties.totalDistance / 1000).toFixed(1) + "km, ";
                var tTime = "ì´ ì‹œê°„ : " + (resultData[0].properties.totalTime / 60).toFixed(0) + "ë¶„, ";
                var tFare = "ì´ ìš”ê¸ˆ : " + resultData[0].properties.totalFare + "ì›, ";
                var taxiFare = "ì˜ˆìƒ íƒì‹œìš”ê¸ˆ : " + resultData[0].properties.taxiFare + "ì›";
                $("#result").css('color', '#2777f7').text(tDistance + tTime + tFare + taxiFare);

                // ì¶œë°œì§€, ë„ì°©ì§€ ë§ˆì»¤
                marker_s = new Tmapv2.Marker({
                    position: new Tmapv2.LatLng(start.lat, start.lng),
                    icon: "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png",
                    iconSize: new Tmapv2.Size(24, 38),
                    map: map
                });
                marker_e = new Tmapv2.Marker({
                    position: new Tmapv2.LatLng(end.lat, end.lng),
                    icon: "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png",
                    iconSize: new Tmapv2.Size(24, 38),
                    map: map
                });
                resultMarkerArr.push(marker_s);
                resultMarkerArr.push(marker_e);

                // ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸°
                drawInfoArr = [];
                for (var i in resultData) {
                    var geometry = resultData[i].geometry;
                    if (geometry.type === "LineString") {
                        for (var j in geometry.coordinates) {
                            var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                            var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                            var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);
                            drawInfoArr.push(convertChange);
                        }
                    }
                }
                var polyline_ = new Tmapv2.Polyline({
                    path: drawInfoArr,
                    strokeColor: "#2777f7",
                    strokeWeight: 7,
                    map: map
                });
                resultdrawArr.push(polyline_);
                // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                map.setCenter(new Tmapv2.LatLng((start.lat + end.lat) / 2, (start.lng + end.lng) / 2));
            },
            error: function (request, status, error) {
                $("#result").css('color', '#d11').text("ì—ëŸ¬ ë°œìƒ! ì•±í‚¤, ë„¤íŠ¸ì›Œí¬, ì¿¼í„°, ìƒí’ˆ í™œì„±í™” ì—¬ë¶€ í™•ì¸");
            }
        });
    }

    // ì§€ë„/ë§ˆì»¤/ê²½ë¡œ ì´ˆê¸°í™”
    function resettingMap() {
        if (marker_s) marker_s.setMap(null);
        if (marker_e) marker_e.setMap(null);
        if (resultMarkerArr.length > 0) {
            for (var i = 0; i < resultMarkerArr.length; i++) resultMarkerArr[i].setMap(null);
        }
        if (resultdrawArr.length > 0) {
            for (var j = 0; j < resultdrawArr.length; j++) resultdrawArr[j].setMap(null);
        }
        drawInfoArr = [];
        resultMarkerArr = [];
        resultdrawArr = [];
    }
</script>
</body>
</html>
